![[Pasted image 20250322142047.png]]
### 业务内容
1. 后台增删员工，员工分页查询逻辑，禁用员工账号
2. 编辑员工
3. 菜品公共字段自动填充，新增菜品，菜品分页查询，删除菜品，修改菜品
4. 店铺营业状态，
5. 微信登录怎么弄的？
6. 缓存菜品，缓存套餐，添加购物车，查看清空购物车
7. 来电提醒，客户催单，营业额统计，订单统计，销量排名
### 后台管理系统的接口笔记
1. Jwt 通过中间件的机制加入项目，其中通过除了 login 外的后台请求都是私有请求，都需要通过 Jwt 校验
2. 增删改菜品都是基于事务的，在 Dao 层如果正常不开启事务是传入的 db 连接，但是开启事务后，需要在修改前创建事务，然后传入 tx，后续的修改都是基于 tx 的，最后由 tx 统一 commite
3. 缓存菜品逻辑分析：我在前台展示菜品的时候，是按照分类来展示的菜品，那么每个分类下缓存一分菜品数据，这样就能查询的时候，直接将查询到的缓存展示到前台。(KV：分类 Id：和菜品)(dish_1 ：菜品 A + 菜品 B + 菜品 C)用的是 string 来保存的 value，然后通过字符串分割来返回
4. 缓存流程是先去查有没有对应的菜品，有的话返回，没有的话去数据库中查，查完加入缓存，最后返回
5. 缓存更新流程是，当数据库操作更新完毕后，然后删除对应分类的缓存，删除一整个分类哦；批量删除的时候，直接删除所有的 redis 分类缓存，因为批量删除的时候，传入的是菜品的 id，还要去数据库中查对应的分类，所以可以直接全处理掉。增删套餐的逻辑是一致的。
### 项目中Redis和Mysql怎么保证缓存数据一致性的？
首先，当我进行update 和 del 操作的时候，我会先删除 redis 中的数据，然后在 update，但是这样当我修改数据库的时候，一个读请求打过来，就看造成不一致性，因为我可能还没修改掉，导致脏读，然后回写到Redis中也是脏的。然后我mysql改完，会再删一次 redis，尽量保证数据不一致性发生的次数尽可能的少。这是分布式事务的东西，只能保证数据的最终一致性，很难保证即时一致性（强一致性）。其实比较好的方案是先修改数据库，在删除 redis，这样能尽可能保证一致性，但还是会有一定的问题。最好的方案，修改数据库，删除缓存，然后过一会再删除一次 redis。这个删除时间选择为读一次的时间
### 前台的小程序的后台的接口笔记
1. 默认地址修改，先将所有的地址改为非默认，然后再将对应的地址改为默认，等于执行了两个 sql
2. 购物车全局一个表，每个记录由一个对应的 userID，dishID，setMealID，
3. 增加购物车先判断购物车里有没有被增加对象，有的话直接 num ++
### 外卖超时
1. cron 表达式生成器
2. 对于未支付的订单，每分钟执行 Task 一次，查询数据库中那些订单状态为未支付并且订单的创建时间小于(当前时间 - 15min)的订单，然后进行 update 即可
### Websocket
当使用 http 的时候，我们可以发现，当且客户端发请求的时候，服务器才会回应，不然客户端是不会主动回应的。要是想给予 http 实现这种服务器主动发给客户端的需求，可以让前端偷偷发请求给服务器，然后由服务器来返回，但这实际上还是请求-响应模型（http 定时轮询）。但是，短轮询消耗贷款，于是可以长轮询，服务器收到客户端请求后，将超时时长设置为 30s这么长，这样在这 30s 内，比如说用户扫码了，就发给客户端。但是这种应对扫码这样的场景还算 ok，但如果是网页游戏呢？一次要发很多请求给服务器。这个时候就有了 websocket，是一种全双工的协议，因为 http1.1 是一个半双工的。当需要升级为 websocket 的时候，会在http 的请求头里加上 upgrade 信息，告知服务器要升级到全双工的 websocket 请求。websocket 是一个独立的协议，只是在建立连接的时候用到了 http 协议。
1. 基于 TCP，适用于弹幕，网页聊天
### 数据库表结构
#### 员工表（涉及到后台系统的登录和菜品管理）
注意，id 用的是 bigint

| id  | name | username | password | phone | sex | id_number | status | create_time | update_time | create_time | update_user |
| --- | ---- | -------- | -------- | ----- | --- | --------- | ------ | ----------- | ----------- | ----------- | ----------- |
| 1   | 管理员  | root     | xxxx     | xxx   | xxx | xxx       | xxx    | xxx         |             |             |             |

#### 菜品表
注意，id 用的是 bigint
这里的 category_id 也是逻辑外键，对应的是种类表的主键
这里的update_user 和 create_user 是逻辑外键，关联到员工表的主键
image 是verchar(255)，里面存的是图片对应的 oss 地址

| id  | name | category_id | price | image | description | status | create_time | update_time | create_time | update_user |
| --- | ---- | ----------- | ----- | ----- | ----------- | ------ | ----------- | ----------- | ----------- | ----------- |
| 1   | 茄子   | xxx         | xxxx  | xxx   | xxx         | xxx    | xxx         |             |             |             |
#### 菜品及套餐分类表
注意，id 用的是 bigint
这里的update_user 和 create_user 是逻辑外键，关联到员工表的主键

| id  | type | name | sort | status | create_time | update_time | create_user | update_user |
| --- | ---- | ---- | ---- | ------ | ----------- | ----------- | ----------- | ----------- |
| 1   | xxx  | xxx  | xxxx | xxx    | xxx         | xxx         | xxx         | xxx         |
### 菜品口味关系表
dish_id 是逻辑外键，对应菜品表的主键
value 是 varchar(255) ，是菜品的口味选项

| id  | dish_id | name | value |
| --- | ------- | ---- | ----- |
| 1   | 管理员     | root | xxxx  |
#### 套餐表
id 是主键
这里的update_user 和 create_user 是逻辑外键，关联到员工表的主键
category 是逻辑外键，对应到分类表的主键

| id  | category_id | name | price | status | description | image | create_time | update_time | create_time | update_time |
| --- | ----------- | ---- | ----- | ------ | ----------- | ----- | ----------- | ----------- | ----------- | ----------- |
| 1   | xxx         | xxx  | xxxx  | xxx    | xxx         | xxx   | xxx         | xxx         | xxx         | xxx         |
#### 套餐菜品关系表
id 是主键
setmeal_id 是套餐 id，是逻辑外键，对应套餐表的主键
dish_id 是菜品的 id，是逻辑外键，对应菜品表的主键

| id  | setmeal_id | dish_id | name | price | copies |
| --- | ---------- | ------- | ---- | ----- | ------ |
| 1   | 100        | root    | xxxx | xxx   | xxx    |
#### 用户表
用户信息
id 是主键
openid 是微信用户唯一表示
##### 微信登录流程
![[Pasted image 20250323152750.png]]

| id  | open_id | name | phone | sex | id_number | avatar | create_time |
| --- | ------- | ---- | ----- | ---- | --------- | ------ | ----------- |
| 1   | 100     | root | xxxx  | xxx  | xxx       | xxx    | xxx         |